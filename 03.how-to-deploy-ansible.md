# 現代 IT 人一定要知道的 Ansible 自動化組態技巧

## 03. 怎麼部署 Ansible 環境？

在本次的章節裡，凍仁將簡單地介紹 Ansible 基本觀念和怎麼安裝、設定 Ansible。

![automate_with_ansible_basic-11.jpg](imgs/automate_with_ansible_basic-11.jpg)


### Ansible 是怎麼運作的？

在 Ansible 的世界裡，我們會透過 **inventory 檔案**來定義有哪些 **Managed node** (被控端)，並藉由 **SSH** 和 **Python** 進行溝通。

![automate_with_ansible_basic-12.jpg](imgs/automate_with_ansible_basic-12.jpg)

換句話說，當 Control Machine (主控端) 可以用 SSH 連上 Managed node，且被連上的機器裡有預載 Python 時，Ansible 就可以運作了！

- `Control Machine` 指的是我們主要會在上面操作 Ansible 的機器，凍仁喜歡用**主控端**來形容它。它可以是我們平時用的電腦、手機 [^1] 或機房裡的某一台機器，也可以把它想成是一般 Lab 練習裡的 `Workstation`。

- `Managed node` 則是被 Ansible 操縱的機器，凍仁喜歡用**被控端**來形容它。在很多的 Lab 練習裡會用 `Server` 來稱呼它。


### 怎麼安裝 Ansible？

在一般的情況下，**我們只需在 Control Machine 裡安裝 Ansible 即可**，因為 GNU/Linux 和 macOS 的 Managed node 都早已預載了 Python 2.5 以上的版本，且開通了 SSH 連線的條件。

若想拿 Ansible 來管 Windows 了話，則需進行較多的設置，這部份凍仁將在之後的「怎麼用 Ansible 管 Windows？」一章提到，當然大家也可以先參考凍仁先前的[簡報][automate-with-ansible-roles-windows]和[官方文件][windows_support]。

[automate-with-ansible-roles-windows]: http://note.drx.tw/2016/07/automate-with-ansible-roles-windows.html
[windows_support]: http://docs.ansible.com/ansible/intro_windows.html

![automate_with_ansible_basic-13.jpg](imgs/automate_with_ansible_basic-13.jpg)

#### 在 Control Machine 上安裝 Ansible

礙於文章篇幅，這裡只會提到凍仁較常用的環境，其餘的部份還請參考[官方文件][ansible_official_installation]和 Ansible 台灣使用者社群所維護的 [Ansible 安裝教學][ansible_tw_installation]。

[ansible_official_installation]: http://docs.ansible.com/ansible/intro_installation.html
[ansible_tw_installation]: http://ansible.tw/#!docs/installation.md

> 目前最新釋出的 Ansible 版本為 v2.2.0.0。

##### Ubuntu (Apt)

1. 安裝 `add-apt-repository` 必要套件。

        $ sudo apt-get install python-software-properties software-properties-common

2. 使用 Ansible 官方的 PPA 套件來源。

        $ sudo add-apt-repository ppa:ansible/ansible -y; sudo apt-get update

3. 安裝 Ansible。

        $ sudo apt-get install ansible

##### CentOS (Yum)

1. 新增 `epel-release` 第三方套件來源。

        $ sudo yum install -y epel-release

2. 安裝 Ansible。

        $ sudo yum install -y ansible

##### macOS (Homebrew)

1. 請先安裝 [homebrew](http://brew.sh/index_zh-tw.html)，已安裝者請略過。

        $ /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

2. 安裝 Ansible。

        $ brew install ansible

#### 在 Managed Node 安裝 OpenSSH server 和 Python

正常在 Managed Node 我們都會安裝 OpenSSH server 並開通連線權限以便利遠端管理，這邊凍仁就不多加贅述了。

雖說現代的 GNU/Linux 都早已內建 Python，但不巧的是 Ansible 目前在 Python 3.4 上還有些問題。這部份凍仁會在後頭的「怎麼用 Ansible 管 Ubuntu 16.04？」一文有較詳細的敘述。

- Ubuntu.

        $ sudo apt-get install -y openssh-server python2.7

- CentOS.

        $ sudo yum install -y openssh-server python

- macOS: 在 macOS 10.11 裡，我們只需使用內建的 OpenSSH server 和 Python 即可，詳情請參考 Apple 官方的 [OS X El Capitan: 允許遠端電腦取用您的 Mac](https://support.apple.com/kb/PH21839?viewlocale=zh_TW&locale=zh_TW) 一文進行設置。


### 怎麼設定 Ansible？

我們可以藉由 `ansible.cfg` 來設定 inventory 檔案的路徑還有許許多多 Managed node 的相關設定。

![automate_with_ansible_basic-14.jpg](imgs/automate_with_ansible_basic-14.jpg)

若有本機測試需求，建議於 Control Machine 的 /etc/ansible/hosts 補上 `local` 的設定。

#### inventory 是什麼？

我們可以把 inventory 想像成是把設定檔和主機列表拆開的設定檔 …、

inventory 就字面上有 "詳細目錄"、"完整清單" 的意思。在 Ansible 是用來定義被控端的主機位址、群組還有 ssh 連線資訊。

![automate_with_ansible_basic-15.jpg](imgs/automate_with_ansible_basic-15.jpg)


### 資料來源

* [凍仁的筆記: 現代 IT 人一定要知道的 Ansible 自動化組態技巧](http://note.drx.tw/2016/05/automate-with-ansible-basic.html)

[^1]: 相信在這個智慧型手機裡盛行的時代，要在手機裡裝個 Python 和 OpenSSH 一定不是什麼難事 (笑)。在台灣還有人整合了 Ansible 與聊天機器人 (Chatbot)，這樣出門在外只要有手機和網路就可以遠端工作了！(詳情請參考[從 DevOps 到 ChatOps：War Room、Bots 與 Automation][devops-chatopswar-roombots-automation] 的簡報)

[devops-chatopswar-roombots-automation]: http://www.slideshare.net/warfan/devops-chatopswar-roombots-automation
